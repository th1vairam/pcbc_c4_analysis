---
title: Stratify EBs using markers of pluripotency and germline stages
author: "Thanneer Perumal"
date: '`r date()`'
output: pdf_document
---
```{r knit2synapse, eval = FALSE, include=FALSE}
library(synapseClient)
library(knitr)
library(knit2synapse)

synapseLogin()

knit2synapse::knitToFolderEntity(file = 'Section2a_CIBERSORT.Rmd',
                                 parentId = "syn7162983",
                                 entityName = "2a Stratify EBs using germline and pluripotency markers")
```

```{r libs, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
## It is assumed your working directory is where this file is

# Clear R console screen output
cat("\014")

# Load libraries
library(CovariateAnalysis)
library(data.table)
library(tidyr)
library(plyr)
library(dplyr)
library(stringr)

library(ggplot2)
library(RColorBrewer)
library(ComplexHeatmap)
library(matrixStats)

library(fpc)
library(WGCNA)
library(flashClust)

library('RColorBrewer')
library('ggplot2')
library('gplots')
library('limma')
library('edgeR')
library('ctv')
library('psych')
library('reshape2')
library('vcd')
library('erer')
library('fpc')

library(synapseClient)
library(knitr)
library(githubr)

library(SNFtool)
library(igraph)
library(Vennerable)

synapseLogin()

library(circlize)
colfunc <- colorRampPalette(c("white", "red"))

# Requires ggdendro
devtools::source_url("https://raw.githubusercontent.com/chr1swallace/random-functions/master/R/ggplot-heatmap.R")

options(xtable.type="html")

knitr::opts_chunk$set(
  echo=FALSE,
  warning=FALSE,
  message=FALSE,
  error = FALSE,
  tidy = FALSE,
  cache = TRUE,
  fig.align = 'left',
  results = 'asis',
  out.width = '8in')
```

```{r synapseStore.params, include=FALSE}
parentId = "syn7162983"
ALL_USED_IDs = c()

thisFileName = 'Section2a_CIBERSORT.Rmd'

# Github link
thisRepo <- getRepo(repository = "th1vairam/pcbc_c4_analysis", 
                    ref="branch", 
                    refName='publication')

thisFile <- getPermlink(repository = thisRepo,
                        repositoryPath=paste0('code/Rmd/', thisFileName))
```
### Data download from synapse
#### Get raw logCPM counts from synapse
```{r getRawCount, include=FALSE}
expr.id = c(mrna = 'syn5011095', mirna = 'syn5014454', methyl = 'syn4487642')
ALL_USED_IDs = c(ALL_USED_IDs, as.character(expr.id))
expr = lapply(expr.id, downloadFile)
```

#### Get covariates from synapse
```{r covars, include=FALSE}
covariates.id = c(mrna = 'syn5011149', mirna = 'syn5014460', methyl = 'syn4487669')
covariates.table.id = c(mrna = 'syn3156503', mirna = 'syn3219876', methyl = 'syn3156828')
ALL_USED_IDs = c(ALL_USED_IDs, as.character(covariates.id), as.character(covariates.table.id))
covariates = lapply(covariates.id, downloadFile)
covariates.table = lapply(covariates.table.id, function(x){
  synTableQuery(paste('select UID,C4_Cell_Line_ID from',x))@values
})

covariates = mapply(function(x,y){
  left_join(x,y)
},covariates, covariates.table)
```

#### Get pluripotency and germline specific markers from synapse
```{r get.markers}
state.specific.signatures = downloadFile('syn7187534')
ALL_USED_IDs = c(ALL_USED_IDs, 'syn7187534')
```

### Merge expression data to unique cell line ID
#### Merge expression data
```{r expr.merge}
# Summarise expression data to unique cell line IDs
orderedDiffState = sort(c("SC", "DE", "MESO15", "MESO30", "ECTO", "EB"))
merged.expr = list()
for (diffstate in orderedDiffState){
  merged.expr[[diffstate]] = list()
  for (assay in c('mrna','mirna','methyl')){
    covar = filter(covariates[[assay]], Diffname_short == diffstate)
    
    exp = expr[[assay]]
    
    rownames(exp) = exp[,1]
    exp[,1] = NULL
    exp = exp[rownames(exp) %in% state.specific.signatures$feature,]
    
    merged.expr[[diffstate]][[assay]] = ddply(covar %>% droplevels, .(C4_Cell_Line_ID), .fun = function(x, exp){
      rowMeans(exp[,x$UID,drop=F], na.rm=T)
    }, exp)
  }
}

merged.expr$MESO15$methyl = NULL
merged.expr$MESO30$methyl = NULL
intersect.ids = lapply(merged.expr, function(exp){
  lapply(exp, function(x){x$C4_Cell_Line_ID }) %>%
    Reduce(intersect,.)
})

merged.expr = lapply(merged.expr, function(x){
  join_all(x, type='inner')
})

merged.expr = mapply(function(x,y){
  y$C4_Cell_Line_ID = paste(y$C4_Cell_Line_ID, x, sep = '.')
  return(y)
}, names(merged.expr), merged.expr, SIMPLIFY = F) %>%
  rbindlist(idcol = 'Diffname_short', use.names = T, fill = T)
```

### Characterise EBs using pluripotency and germline signatures
Since, EBs are derivatives of pluripotent and/or germlayer states, we characterised our EBs as a mixture model of the above identified signatures

```{r pca.ebs}
tmp = merged.expr %>%
  dplyr::select(-Diffname_short, -C4_Cell_Line_ID) %>%
  t
colnames(tmp) = merged.expr$C4_Cell_Line_ID
tmp = na.omit(tmp)

tmp.EB = tmp[,grep('.EB',colnames(tmp))]
tmp.notEB = tmp[,setdiff(1:dim(tmp)[2], grep('.EB',colnames(tmp)))]

# Reproject all eb samples in to the above PC space
PC.gene.space = prcomp(t(tmp.notEB), scale. = T, center = T)
eb.pc = sapply(1:dim(tmp)[2], function(i, expr.eb, pc.rotation){
  lm(expr ~ 0 + ., cbind(data.frame(expr = scale(expr.eb[rownames(pc.rotation),i])), pc.rotation))$coefficients
}, tmp, PC.gene.space$rotation) %>% t
rownames(eb.pc) = colnames(tmp)
eb.pc = rownameToFirstColumn(eb.pc, 'C4_Cell_Line_ID') %>%
  left_join(merged.expr %>%
              dplyr::select(Diffname_short, C4_Cell_Line_ID)) 

p = ggplot(eb.pc, aes(x = PC1, y = PC2, color = Diffname_short, shape = Diffname_short)) + geom_point()
p
```
From the above PC plot we can conclude that most of our EBs are close to late mesoderm states at day 15 and 30. However, as we can see, they are stratified in the axis of mesoderm and ectoderm signatures. Therefore it is to say that some of our EBs show more mesoderm like and the others are less mesoderm/ more ectoderm like signatures. Inorder to quantify this degree of seperation we used cibersort analysis to stratify EBs based on ecto and mesoderm signatures.

Normalise and prepare data for CIBERSORT
```{r cibersort.prep, include=FALSE}
# Standard normalisation of signatures
ind.expr = c(grep('.ECTO', colnames(tmp.notEB)), grep('.MESO', colnames(tmp.notEB)))
signature.expr = tmp.notEB[,ind.expr] %>%
  rownameToFirstColumn('hgnc_symbol')

mixture.expr = join_all(list(tmp.notEB[,ind.expr] %>%
                               rownameToFirstColumn('hgnc_symbol'),
                             tmp.EB %>%
                               rownameToFirstColumn('hgnc_symbol')), type = 'full')

phenotype = matrix(2, 2, dim(signature.expr)[2])
rownames(phenotype) = c('MESO', 'ECTO')
ind = c(grep('MESO15', colnames(signature.expr)),
        grep('MESO30', colnames(signature.expr)))
phenotype['MESO',ind] = 1

ind = grep('ECTO', colnames(signature.expr))
phenotype['ECTO',ind] = 1

phenotype[,1] = rownames(phenotype)

CODE <- Folder(name = '2a Stratify EBs using germline and pluripotency markers',parentId = 'syn7162983')
CODE <- synStore(CODE)

write.table(signature.expr, file = 'SignatureExpr.txt',sep = '\t', row.names=F, quote=F)
obj = File('SignatureExpr.txt', name = 'Signature Matrix', parentId = CODE$properties$id)
obj = synStore(obj, activityName = 'Stratify EBs', executed = thisFile, used = ALL_USED_IDs)

write.table(phenotype, file = 'Phenotype.txt',sep = '\t', row.names=F, quote=F, col.names=F)
obj = File('Phenotype.txt', name = 'Phenotype Matrix', parentId = CODE$properties$id)
obj = synStore(obj, activityName = 'Stratify EBs', executed = thisFile, used = ALL_USED_IDs)

write.table(mixture.expr, file = 'MixtureExpr.txt',sep = '\t', row.names=F, quote=F)
obj = File('MixtureExpr.txt', name = 'Mixture Matrix', parentId = CODE$properties$id)
obj = synStore(obj, activityName = 'Stratify EBs', executed = thisFile, used = ALL_USED_IDs)
```

```{r cibersort.output, fig.height=8, fig.width=8}
cibersort.results = downloadFile('syn7187931') %>%
  plyr::rename(c('Input Sample' = 'Input_Sample')) %>%
  dplyr::select(Input_Sample, MESO, ECTO) %>%
  gather(DiffState, Value, -Input_Sample) %>%
  dplyr::rename(Fraction = Value, ReferenceState = DiffState) %>%
  tidyr::separate(Input_Sample, c('C4_Cell_Line_ID','DifferentiationStage'), sep = '\\.')

p = ggplot(cibersort.results %>% 
             filter(DifferentiationStage == 'EB'), aes(x = C4_Cell_Line_ID, y = Fraction, fill = ReferenceState)) + geom_bar(stat = 'identity')
p = p + theme(axis.text.x = element_text(angle = 90, hjust = 1))
p = p + facet_grid(DifferentiationStage~.)
p

tmp = eb.pc %>%
  tidyr::separate(C4_Cell_Line_ID, c("C4_Cell_Line_ID", "DifferentiationStage"),sep = '\\.') %>%
  dplyr::select(C4_Cell_Line_ID, DifferentiationStage, PC2) %>%
  inner_join(cibersort.results) %>%
  spread(ReferenceState, Fraction) %>%
  filter(DifferentiationStage == 'EB')

writeLines('Relationship between ecto scores from cibersort and pc2 from the decomposition of signatures')
p = ggplot(tmp, aes(y = PC2, x = ECTO)) + geom_point() + geom_smooth(method = lm)
p = p + geom_text(aes(label=C4_Cell_Line_ID),hjust=0, vjust=0)
p
```

Association test between different covariates and stratified diff state scores of EBs
```{r associate.with.covars, fig.height=10, fig.width=10}
covars = covariates$mrna %>%
  filter(Diffname_short == 'EB') %>%
  dplyr::select(C4_Cell_Line_ID, Cell_Line_Type, Cell_Line_of_Origin, Tissue_of_Origin, 
                Reprogramming_Gene_Combination, Culture_Conditions, Donor_Life_Stage,
                Gender, Cell_Type_of_Origin_Level2, Reprogramming_Vector_Type) %>%
  unique() %>%
  right_join( cibersort.results ) %>%
  as.data.frame() %>%
  filter(DifferentiationStage == 'EB') %>%
  spread(ReferenceState, Fraction)

factor_covars = c("Cell_Line_Type", "Cell_Line_of_Origin", "Tissue_of_Origin", "Reprogramming_Gene_Combination", 
                  "Culture_Conditions", "Donor_Life_Stage", "Gender", "Cell_Type_of_Origin_Level2", "Reprogramming_Vector_Type")
cont_covars = c("ECTO", "MESO")

covars1 = covars[,c(factor_covars, cont_covars)]
covars1[,factor_covars] = lapply(covars[,factor_covars], as.factor)
covars1[,cont_covars] = lapply(covars[,cont_covars], as.numeric)
rownames(covars1) = covars$C4_Cell_Line_ID

COVARIATES.CORRELATION = getAssociationStatistics(covars1, PVAL = 0.1)
ggheatmap.show(COVARIATES.CORRELATION$plot, col.width=0.5, row.width=0.1)
```
No Association between any covariates is observed